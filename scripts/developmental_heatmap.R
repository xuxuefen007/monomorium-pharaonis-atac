# ==============================================================================
# Developmental Chromatin Accessibility Heatmap Analysis
# 
# Description: This script analyzes chromatin accessibility dynamics during
# embryonic development from 0-12h embryo to 1st instar larva.
# 
# Input Files:
# 1. monomorium_50.csv: Sample sheet containing metadata for 50 samples
#    (embryo_0_12h to larva_1st stages with biological replicates)
# 2. consensus_diff_peaks.bed: Consensus differential peaks generated by
#    pairwise comparisons between embryo_0_12h and all subsequent stages
# 
# Output Files:
# 1. monomorium_count_50.RData: Processed DiffBind object with read counts
# 2. heatmap_developmental_vertical.pdf: Heatmap visualization
# ==============================================================================

# Load required libraries
library(DiffBind)
library(DESeq2)
library(pheatmap)
library(GenomicRanges)

# ==============================================================================
# PART A: Data Processing Pipeline (Creating monomorium_count_50.RData)
# ==============================================================================

# This section creates the monomorium_count_50.RData file from raw sample data

setwd("/data/work/embryo/")

# ------------------------------------------------------------------------------
# Step 1: Create DiffBind object from sample sheet
# ------------------------------------------------------------------------------
# monomorium_50.csv contains metadata for 50 samples spanning developmental
# stages from embryo_0_12h to larva_1st, including biological replicates
monomorium <- dba(sampleSheet = "monomorium_50.csv")

# ------------------------------------------------------------------------------
# Step 2: Generate consensus peaks by condition
# ------------------------------------------------------------------------------
# Create consensus peaks within each developmental condition
# minOverlap = 0.66: peaks must be present in at least 66% of replicates
consensus_by_condition <- dba.peakset(
    monomorium, 
    consensus = DBA_CONDITION, 
    minOverlap = 0.66
)

# ------------------------------------------------------------------------------
# Step 3: Merge consensus peaks across all conditions
# ------------------------------------------------------------------------------
# Create final consensus peaks that are present across all conditions
all_consensus <- dba(
    consensus_by_condition, 
    mask = consensus_by_condition$masks$Consensus, 
    minOverlap = 1
)
final_peaks <- dba.peakset(all_consensus, bRetrieve = TRUE)
cat("Generated", length(final_peaks), "consensus peaks\n")

# ------------------------------------------------------------------------------
# Step 4: Count reads in consensus peaks
# ------------------------------------------------------------------------------
monomorium <- dba.count(monomorium, peaks = final_peaks)

# ------------------------------------------------------------------------------
# Step 5: Save processed data
# ------------------------------------------------------------------------------
save(monomorium, file = "monomorium_count_50.RData")
cat("Saved processed data: monomorium_count_50.RData\n")

# ==============================================================================
# PART B: Differential Peak Analysis and Heatmap Generation
# ==============================================================================

# ------------------------------------------------------------------------------
# Step 6: Load processed data
# ------------------------------------------------------------------------------
# Load the pre-computed DiffBind object containing ATAC-seq data for
# all 50 samples from embryo_0_12h to larva_1st
load("monomorium_count_50.RData")

# ------------------------------------------------------------------------------
# Step 7: Load consensus differential peaks
# ------------------------------------------------------------------------------
# This file contains genomic regions showing differential chromatin accessibility
# between embryo_0_12h and all subsequent developmental stages.
# Generation process:
# 1. Differential analysis between embryo_0_12h and each subsequent stage:
#    - embryo_0_12h vs embryo_12_24h
#    - embryo_0_12h vs embryo_36_48h
#    - embryo_0_12h vs embryo_60_72h
#    - embryo_0_12h vs embryo_84_96h
#    - embryo_0_12h vs embryo_108_120h
#    - embryo_0_12h vs embryo_132_144h
#    - embryo_0_12h vs embryo_156_168h
#    - embryo_0_12h vs embryo_180_192h
#    - embryo_0_12h vs larva_1st
# 2. Filtered for FDR < 0.01 and |log2FC| > 0.5
# 3. Merged using bedtools merge with 500bp distance threshold
consensus_peaks <- read.table(
    "consensus_diff_peaks.bed", 
    header = FALSE, 
    sep = "\t",
    col.names = c("chr", "start", "end")
)

# Convert to GRanges object
consensus_gr <- GRanges(
    seqnames = consensus_peaks$chr,
    ranges = IRanges(
        start = consensus_peaks$start,
        end = consensus_peaks$end
    )
)

# ------------------------------------------------------------------------------
# Step 8: Count reads in differential consensus peaks
# ------------------------------------------------------------------------------
monomorium$config$cores <- 6
raw_counts <- dba.count(
    monomorium, 
    peaks = consensus_gr, 
    bParallel = TRUE, 
    score = DBA_SCORE_READS
)

# Save count results
save(raw_counts, file = "monomorium_diff_count_50.RData")

# Load saved count data
load("monomorium_diff_count_50.RData")

# ------------------------------------------------------------------------------
# Step 9: Extract and normalize count matrix
# ------------------------------------------------------------------------------
counts_matrix <- as.matrix(mcols(dba.peakset(raw_counts, bRetrieve = TRUE)))

# DESeq2 normalization
dds <- DESeqDataSetFromMatrix(
    countData = counts_matrix,
    colData = raw_counts$samples,
    design = ~ Condition
)
dds <- estimateSizeFactors(dds)
norm_counts <- counts(dds, normalized = TRUE)

# ==============================================================================
# PART C: Developmental Time Course Analysis
# ==============================================================================

# ------------------------------------------------------------------------------
# Step 10: Define and order developmental stages
# ------------------------------------------------------------------------------
dev_stages <- c(
    "embryo_0_12h", "embryo_12_24h", "embryo_36_48h",
    "embryo_60_72h", "embryo_84_96h", "embryo_108_120h",
    "embryo_132_144h", "embryo_156_168h", "embryo_180_192h",
    "larva_1st"
)

# Reorder samples by developmental progression
sample_order <- order(match(raw_counts$samples$Condition, dev_stages))
norm_counts_ordered <- norm_counts[, sample_order]

# ------------------------------------------------------------------------------
# Step 11: Calculate stage means and prepare heatmap data
# ------------------------------------------------------------------------------
# Calculate mean accessibility for each developmental stage
stage_means <- sapply(dev_stages, function(stage) {
    stage_cols <- grep(stage, colnames(norm_counts_ordered))
    if (length(stage_cols) > 1) {
        rowMeans(norm_counts_ordered[, stage_cols])
    } else {
        norm_counts_ordered[, stage_cols]
    }
})

# Log2 transform and transpose
log_stage_means <- t(log2(stage_means + 1))

# Select top 1000 most variable peaks
peak_vars <- apply(log_stage_means, 2, var)
top_peaks <- order(peak_vars, decreasing = TRUE)[1:1000]
top_matrix <- log_stage_means[, top_peaks]

# ------------------------------------------------------------------------------
# Step 12: Generate heatmap
# ------------------------------------------------------------------------------
pdf("heatmap_developmental_vertical.pdf", width = 15, height = 6)

pheatmap::pheatmap(
    mat               = top_matrix,
    scale             = "column",
    cluster_cols      = TRUE,
    cluster_rows      = FALSE,
    show_rownames     = TRUE,
    show_colnames     = FALSE,
    color             = colorRampPalette(c("blue", "white", "red"))(100),
    main              = "Chromatin Accessibility Dynamics During Development",
    angle_col         = 45,
    gaps_row          = seq_len(length(dev_stages) - 1),
    labels_row        = dev_stages,
    fontsize_row      = 10,
    fontsize_col      = 8,
    border_color      = NA,
    treeheight_col    = 0,
    silent            = FALSE
)

dev.off()

